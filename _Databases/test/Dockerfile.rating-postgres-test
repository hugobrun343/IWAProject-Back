FROM postgres:15-alpine

# Expose PostgreSQL port
EXPOSE 5432

# Set data directory for test environment
VOLUME ["/var/lib/postgresql/data/rating-db-test"]

# Test environment optimizations
ENV POSTGRES_INITDB_ARGS="--auth-host=trust --auth-local=trust"

# Faster settings for test environment (less durability, more speed)
RUN echo "# Test environment optimizations" >> /usr/local/share/postgresql/postgresql.conf.sample && \
    echo "fsync = off" >> /usr/local/share/postgresql/postgresql.conf.sample && \
    echo "synchronous_commit = off" >> /usr/local/share/postgresql/postgresql.conf.sample && \
    echo "full_page_writes = off" >> /usr/local/share/postgresql/postgresql.conf.sample && \
    echo "checkpoint_completion_target = 0.9" >> /usr/local/share/postgresql/postgresql.conf.sample && \
    echo "wal_buffers = 16MB" >> /usr/local/share/postgresql/postgresql.conf.sample && \
    echo "shared_buffers = 256MB" >> /usr/local/share/postgresql/postgresql.conf.sample

# More frequent health check for test environment
HEALTHCHECK --interval=10s --timeout=5s --start-period=30s --retries=3 \
    CMD pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB} || exit 1
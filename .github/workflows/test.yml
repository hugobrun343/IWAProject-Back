name: Test

on:
  workflow_run:
    workflows: ["Lint"]
    types:
      - completed
    branches: [main, dev, '**']

jobs:
  test:
    name: Run All Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      
      - name: Set up Docker Buildx (for Testcontainers)
        uses: docker/setup-buildx-action@v3
      
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
      
      - name: Cache Docker layers (for Testcontainers)
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-docker-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-docker-
      
      - name: Verify Docker is running
        run: |
          docker version
          docker ps
      
      - name: Make test script executable
        run: chmod +x ./run-all-tests.sh
      
      - name: Run unit tests
        run: |
          echo "üß™ Running unit tests..."
          ./run-all-tests.sh unit
        env:
          TESTCONTAINERS_REUSE_ENABLE: false
      
      - name: Run integration tests with Testcontainers
        run: |
          echo "üîó Running integration tests with PostgreSQL via Testcontainers..."
          ./run-all-tests.sh integration
        env:
          TESTCONTAINERS_REUSE_ENABLE: false
          TESTCONTAINERS_RYUK_DISABLED: false
      
      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            */target/surefire-reports/
            */target/failsafe-reports/
            test-report.md
          retention-days: 30
      
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            */target/site/jacoco/
          retention-days: 30
      
      - name: Comment test results on PR
        if: github.event.workflow_run.event == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = '## üß™ Test Results\n\n';
            
            try {
              const testReport = fs.readFileSync('test-report.md', 'utf8');
              report += testReport;
            } catch (error) {
              report += '‚ö†Ô∏è Test report not found';
            }
            
            // Find the PR number from the workflow run
            const pr = github.event.workflow_run.pull_requests[0];
            if (pr) {
              github.rest.issues.createComment({
                issue_number: pr.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: report
              });
            }

